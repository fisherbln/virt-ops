---
version: "3"

tasks:
  upgrade-talosctl:
    desc: Upgrade talosctl on client 
    cmds:
      - |
        curl -Lo /usr/local/bin/talosctl https://github.com/talos-systems/talos/releases/latest/download/talosctl-$(uname -s | tr "[:upper:]" "[:lower:]")-amd64 

  get-nodes:
    desc: Get basic node for cluster info
    cmds:
      - talosctl --nodes {{.TALOS_PRIMARY_NODE}} get members
      - kubectl get nodes

  etc-status:
    desc: Sync all Flux GitRepositories
    cmds:
      - |
        talosctl -n {{.TALOS_CONTROL_NODES}} etcd status  

  etc-defrag:
    desc: Sync all Flux Kustomizations
    cmds:
      - |
        kubectl get kustomization --all-namespaces --no-headers | awk '{print $1, $2}' \
          | xargs -P 4 -L 1 bash -c \
            'kubectl -n $0 annotate kustomization/$1 reconcile.fluxcd.io/requestedAt="$(date +%s)" --field-manager=flux-client-side-apply --overwrite'
