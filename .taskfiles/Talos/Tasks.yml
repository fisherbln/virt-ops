---
version: "3"

tasks:
  etc-status:
    desc: Sync all Flux GitRepositories
    cmds:
      - |
        talosctl -n {{TALOS_CONTROL_NODES}} etc status

  etc-defrag:
    desc: Sync all Flux Kustomizations
    cmds:
      - |
        kubectl get kustomization --all-namespaces --no-headers | awk '{print $1, $2}' \
          | xargs -P 4 -L 1 bash -c \
            'kubectl -n $0 annotate kustomization/$1 reconcile.fluxcd.io/requestedAt="$(date +%s)" --field-manager=flux-client-side-apply --overwrite'
