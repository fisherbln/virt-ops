---
    apiVersion: helm.toolkit.fluxcd.io/v2beta1
    kind: HelmRelease
    metadata:
      name: emqx
      namespace: home
    spec:
      interval: 5m
      chart:
        spec:
          # renovate: registryUrl=https://repos.emqx.io/charts
          # based this file on https://github.com/billimek/k8s-gitops/tree/master/default/emqx
          chart: emqx
          version: 5.0.21
          sourceRef:
            kind: HelmRepository
            name: emqx-charts
            namespace: flux-system
          interval: 5m
      install:
        createNamespace: true
        remediation:
          retries: 3
      upgrade:
        remediation:
          retries: 3
      timeout: 20m
      values:
        image:
          repository: emqx/emqx
        replicaCount: 3
        recreatePods: true
        service:
          type: LoadBalancer
          # Brian note: check onedr0ps use of this instead of using ingress
          #annotations:
          #  coredns.io/hostname: emqx.${ORG_DOMAIN}
          externalIPs:
            - ${SVC_EMQX_ADDR_V4}
          externalTrafficPolicy: Local
        #tolerations:
        #  - key: "arm"
        #    operator: "Exists"
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - emqx
                topologyKey: "kubernetes.io/hostname"
        emqxConfig:
          EMQX_ALLOW_ANONYMOUS: "false"
          EMQX_DASHBOARD__DEFAULT_USERNAME: admin
          EMQX_CLUSTER__DISCOVERY_STRATEGY: k8s
          EMQX_LOADED_MODULES: "emqx_mod_presence,emqx_mod_acl_internal,emqx_mod_topic_metrics"
          EMQX_LOADED_PLUGINS: "emqx_management,emqx_recon,emqx_retainer,emqx_dashboard,emqx_rule_engine,emqx_auth_mnesia,emqx_prometheus"
        #   EMQX_ACL_NOMATCH: "deny"
    
        emqxAclConfig: >
          {allow, {user, "dashboard"}, subscribe, ["$SYS/#"]}.
          {allow, {ipaddr, "127.0.0.1"}, pubsub, ["$SYS/#", "#"]}.
          {allow, all, subscribe, ["$SYS/#", {eq, "#"}]}.
          {allow, all}.
    
        resources:
          limits:
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 256Mi
    
        ingress:
          dashboard:
            enabled: true
            ingressClassName: traefik
            annotations:
              #kubernetes.io/ingress.class: traefik
              hajimari.io/appName: "EMQX"
              hajimari.io/icon: simple-icons:eclipsemosquitto
              hajimari.io/instance: "org"
              cert-manager.io/cluster-issuer: letsencrypt-production
              traefik.ingress.kubernetes.io/router.entrypoints: websecure
              traefik.ingress.kubernetes.io/router.middlewares: networking-rfc1918@kubernetescrd
            hosts:
              - &host emqx.${ORG_DOMAIN}
            tls:
              - secretName: tls.emqx
                hosts:
                  - *host
      valuesFrom:
        - targetPath: emqxConfig.EMQX_DASHBOARD__DEFAULT_PASSWORD
          kind: Secret
          name: emqx-config
          valuesKey: mqtt_admin_pass
        - targetPath: emqxConfig.EMQX_AUTH__USER__1__USERNAME
          kind: Secret
          name: emqx-config
          valuesKey: mqtt_username
        - targetPath: emqxConfig.EMQX_AUTH__USER__1__PASSWORD
          kind: Secret
          name: emqx-config
          valuesKey: mqtt_userpass
        - targetPath: emqxConfig.EMQX_AUTH__MNESIA__PASSWORD_HASH
          kind: Secret
          name: emqx-config
          valuesKey: password_hash
    